"function populate_t_id2name_table(selector){"
	"set_var_to_json_then('t', '/a/t.json', function(){"
		"var s = \"\";"
		"for (const [id, tpl] of Object.entries(t)){"
			"s +="
				  "\"<div class='tr'><div class='td'>\""
				"+ display_tag(id, tpl)"
				"+ \"</div></div>\""
			";"
		"}"
		"document.querySelector(selector).innerHTML = s;"
	"});"
"}"
"function set_tag_name_from_id(id, selector){"
	"set_var_to_json_then('t', '/a/t.json', function(){"
		"document.querySelector(selector).innerText = t[id][0];"
	"});"
"}"
"function set_tag_thumb_from_id(id, selector){"
	"set_var_to_json_then('t', '/a/t.json', function(){"
		"document.querySelector(selector).src = t[id][1];"
	"});"
"}"
"function set_tag_cover_from_id(id, selector){"
	"set_var_to_json_then('t', '/a/t.json', function(){"
		"document.querySelector(selector).src = t[id][2];"
	"});"
"}"
"function populate_tagselects(){"
	"set_var_to_json_then('t', \"/a/t.json\", function(){"
		"var s = \"\";"
		"for (const [id, tpl] of Object.entries(t)){"
			"s += \"<option value='\" + id + \"'>\" + tpl[0] + \"</option>\";"
		"}"
		"$(\".tagselect\").html(s).select2();" // Initialise
	"});"
"}"

"function display_tag(id, tpl){"
	"return \"<div class='user'><img src='\" + tpl[1] + \"' class='icon'/><div class='username'><a onclick='view_tag(\" + id + \")'>\" + tpl[0] + \"</a></div></div>\";"
"}"
"function display_tags(tag_ids, selector){"
	"set_var_to_json_then('t', '/a/t.json', function(){"
		"const arr = tag_ids.map(x => display_tag(x, t[x]));"
		"document.querySelector(selector).innerHTML = arr.join(\"<br/>\");"
	"});"
"}"
"function display_tags_add(tag_ids, selector){"
	"set_var_to_json_then('t', '/a/t.json', function(){"
		"const arr = tag_ids.map(x => display_tag(x, t[x]));"
		"document.querySelector(selector).innerHTML += arr.join(\"<br/>\");"
	"});"
"}"
"function display_parent_tags(tag_id, selector){"
	// Similar to display_parent_dirs
	"set_var_to_json_then('t2p', '/a/t2p.json', function(){"
		"display_tags(t2p.filter(x => (x[0] == tag_id)).map(x => x[1]), selector);"
	"});"
"}"
"function display_child_tags(tag_id, selector){"
	"set_var_to_json_then('t2p', '/a/t2p.json', function(){"
		"display_tags(t2p.filter(x => (x[1] == tag_id)).map(x => x[0]), selector);"
	"});"
"}"

"function add_child_tags_then(tag_id, selector, fn){"
	"const tagselect = $(selector);"
	"$.post({"
		"url: \"/t/c/\" + tag_id + \"/\" + tagselect.val().join(\",\"),"
		"success: function(){"
			"tagselect.val(\"\").change();" // Deselect all
		"},"
		"error: function(){"
			"alert(\"Error adding child tags\");"
		"}"
	"});"
	"add_to_json_then('t2p', zipsplitarr(tagselect.val(), [tag_id]), '/a/t2p.json', function(){"
		"fn();"
	"});"
"}"
"function add_parent_tags_then(tag_id, selector, fn){"
	"const tagselect = $(selector);"
	"$.post({"
		"url: \"/t/p/\" + tag_id + \"/\" + tagselect.val().join(\",\"),"
		"success: function(){"
			"tagselect.val(\"\").change();" // Deselect all
		"},"
		"error: function(){"
			"alert(\"Error adding child tags\");"
		"}"
	"});"
	"add_to_json_then('t2p', zipsplitarr([tag_id], tagselect.val()), '/a/t2p.json', function(){"
		"fn();"
	"});"
"}"


"function view_tag(tag_id){"
	"hide('tags-container');"
	"unhide('parents-container');"
	"unhide('children-container');"
	"hide('before-files-tbl');"
	"unhide('f');"
	"hide('d');"
	"hide('t');"
	"unhide('tagselect-files-container');"
	"unhide('tagselect-self-p-container');"
	"unhide('tagselect-self-c-container');"
	
	"file_tagger_fn = after_tagged_selected_files;"
	"get_file_ids = get_selected_file_ids;"
	
	"populate_f_table('/a/f/t/' + tag_id);"
	"fancify_tbl(\"#f .tbody\");"
	
	"set_tag_name_from_id(tag_id, \"#profile-name\");"
	"set_tag_thumb_from_id(tag_id, \"#profile-img\");"
	"set_tag_cover_from_id(tag_id, \"#profile-cover\");"
	
	"display_parent_tags(tag_id, \"#parents\");"
	"display_child_tags(tag_id,  \"#children\");"
"}"
"function view_all_tags(){"
	"hide('tags-container');"
	"hide('parents-container');"
	"hide('children-container');"
	"hide('before-files-tbl');"
	"hide('f');"
	"hide('d');"
	"unhide('t');"
	"hide('tagselect-files-container');"
	"hide('tagselect-self-p-container');"
	"hide('tagselect-self-c-container');"
	"populate_t_id2name_table('#t .tbody');"
"}"
