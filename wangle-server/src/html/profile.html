#include <boost/preprocessor.hpp>

#define ADD_TOGGLE(id, name) \
	"<div id=\"" id "-container\" class=\"toggle-container\">" \
		"<b class=\"toggle-name\">" name "</b>" \
		"<input id=\"" id "\" type=\"checkbox\" class=\"toggle-input\"/>" \
	"</div>"

"<!DOCTYPE html>"
"<html lang=\"en\">"
"<head>"
	"<meta charset=\"utf-8\"/>"
	#include "components/jquery.html"
	#include "components/select2.html"
	
	#include "components/all.css.html"
"</head>"
"<script type=\"text/javascript\">"
	#include "../static/utils.js"
	
	"var tag_id;"
	"var file_id;"
	"var file_name;"
	"var dir_id;"
	"var dir_name;"
	"var device_id;"
	"var mimetype;"
	"var file_tags;"
	"var file2post;"
	
	// External database vars
	"var db_id;"
	"var post_id;"
	"var user_id;"
	"var user_name;"
	
	"var t;"
	"var f;"
	"var d;"
	"var D;"
	"var P;"
	"var t2p;"
	"var x;"
	"var mt;" // mimetypes
	"var f2;" // CSV of file2 variable names that needs to be split into an array
	"var yt_player;"
	
	// User options stored in cookies
	"var use_regex;"
	
	"const tbl2selector = {"
		"\"f2\":\"#file2-select\","
		"\"t\":\".tagselect\","
		"\"d\":\"#dirselect\","
		"\"D\":\"#deviceselect\","
		"\"P\":\"#protocolselect\""
	"};"
	
	"const tbl2namecol = {"
		"\"f2\":null,"
		"\"t\":0,"
		"\"d\":0,"
		"\"D\":0,"
		"\"P\":0"
	"};"
	
	"function onYouTubeIframeAPIReady(){"
		"yt_player = new YT.Player('yt-player', {"
			"height: '390',"
			"width: '640',"
			"events:{"
				"'onStateChange':YTPlayer_onStateChange"
			"}"
		"});"
		"when_data_loaded();"
	"}"
	
	"function when_data_loaded(){"
		"if(t === undefined || d === undefined || D === undefined || P === undefined || t2p === undefined || x === undefined || mt === undefined || f2 === undefined || yt_player === undefined)"
			"return;"
		"const _x = window.location.hash.substr(2);"
		"switch(window.location.hash.substr(1,1)){"
			"case \"f\": view_file(_x); break;"
			"case \"d\": view_dir(_x);  break;"
			"case \"t\": view_tag(_x);  break;"
			"case \"x\":{"
				"const [db_name, thing] = _x.split(\"/\");"
				"db_id = _x.indexOf(db_name);"
				"const thing_id = thing.substr(1);"
				"switch(thing[0]){"
					"case \"u\": view_user(db_id, thing_id); break;"
				"}"
				"break;"
			"}"
			"case \"$\": view_files_by_value(_x); break;"
		"}"
	"}"
	
	"$(document).ready(function(){" // Only execute after page has finished loading
		"hide_all_except([]);"
		
		"refetch_json('t', '/a/t.json', when_data_loaded);"
		"refetch_json('d', '/a/d.json', when_data_loaded);"
		"refetch_json('D', '/a/D.json', when_data_loaded);"
		"refetch_json('P', '/a/P.json', when_data_loaded);"
		"refetch_json('t2p', '/a/t2p.json', when_data_loaded);"
		"refetch_json('x', '/a/x.json', when_data_loaded);"
		"refetch_json('mt', '/a/mt.json', when_data_loaded);"
		"refetch_json('f2', '/a/f2.json', function(){f2=f2.split(\",\");when_data_loaded()});"
		
		// From google's documentation: This code loads the IFrame Player API code asynchronously.
		"let node = document.createElement('script');"
		"node.src = \"https://www.youtube.com/iframe_api\";"
		"let firstScriptTag = document.getElementsByTagName('script')[0];"
		"firstScriptTag.parentNode.insertBefore(node, firstScriptTag);"
		
		"if(use_regex === undefined){"
			"use_regex = get_cookie(\"use_regex\");"
			"if(use_regex !== undefined){"
				"use_regex = (use_regex === \"1\");"
			"}else{"
				"use_regex = confirm(\"Use Regular Expressions?\\nSay no if you don't know what they are\");"
				"set_cookie(\"use_regex\", (use_regex)?\"1\":\"0\", 3600);"
			"}"
		"}"
		
		"fancify_tbl(\"f\");"
		"init_qry();"
		
		"document.getElementById('help-text').innerText = `"
R"=========(
Suppose you have a screenshot of a Twitter post. You can get the link to the original post - for instance, by using 'find-tweet' from https://github.com/NotCompsky/utils. You can then go to that file, click "Update src", and change the source to the Twitter post's URL. This will keep the screenshot as a 'backup' of the post.
)========="
		"`;"
	"});"
"</script>"

"<body>"

R"=========(
<!--
Copyright (c) 2020 by Aysenur Turk (https://codepen.io/TurkAysenur/pen/RwWKYMO)

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
-->
<div id="content">
  <div class="left-side">
    <div class="logo">TAGEM</div>
    <div class="side-wrapper">
      <div class="side-title">SITEMAP</div>
      <div class="side-menu">
)========="
#define CREATE_SITEMAP_LINK(r, data, elem) \
	"<a onclick=\"" BOOST_PP_TUPLE_ELEM(0, elem) "\">" BOOST_PP_TUPLE_ELEM(1, elem) "</a><br/>"
BOOST_PP_SEQ_FOR_EACH(CREATE_SITEMAP_LINK, _, BOOST_PP_VARIADIC_SEQ_TO_SEQ(("view_dirs()","All Dirs")("view_tags()","All Tags")("view_tasks()","All Tasks")("unhide('help')","Help")("view_text_editor()","Text Editor")("add_tags_dialog()","+Tags")("add_files_dialog()","+Files")("add_dirs_dialog()","+Dirs")("add_devices_dialog()","+Devices")))
R"=========(
      </div>
    </div>
    <div class="side-wrapper">
      <div class="side-title">RECENT</div>
      <div class="side-menu">
      </div>
    </div>
    <a href="https://twitter.com/AysnrTrkk" class="follow-me" target="_blank">
      <span class="follow-text">
        <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg>
        CSS/HTML largely based on work by...
     </span>
      <span class="developer">
        <img src="https://pbs.twimg.com/profile_images/1253782473953157124/x56UURmt_400x400.jpg" />
        Aysenur Turk — @AysnrTrkk
      </span>
    </a>
  </div>
  <div class="main">
    <div class="search-bar">
      <input id="qry" type="text" placeholder="Search"/>
      <button class="right-side-button">
         <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
      </button>
    </div>
    <div id="main-container">
      <div class="profile">
        <div class="profile-avatar">
          <img id="profile-img" src="/favicon.ico"/>
          <div id="profile-name"></div>
        </div>
        <img id="profile-cover"/>
)========="
#define CREATE_MENU_ITEM(r, data, elem) \
	"<a onclick=\"" BOOST_PP_TUPLE_ELEM(0, elem) "()\">" BOOST_PP_TUPLE_ELEM(1, elem) "</a>"

		"<div id=\"profile-menu\">"
BOOST_PP_SEQ_FOR_EACH(CREATE_MENU_ITEM, _, BOOST_PP_VARIADIC_SEQ_TO_SEQ(("view_dir","Dir")("view_tag","Tag")("view_tags","Tags")("view_file","File")("view_files","Files")))
		"</div>"
	"</div>"


"<div id=\"qry-help\" class=\"hidden help\">"
	"<h2>How to Query</h2>"
	"<button onclick=\"hide('qry-help')\">Hide</button>"
	"<p>"
		#include "../qry-help-text.txt"
	"</p>"
"</div>"

"<div id=\"tasks-container\">"
	"<h1>Tasks</h1>"
	"<div id=\"tasks\"></div>"
"</div>"

#include "components/help.html"

"<div id=\"file2-container\">"
	"<h3>Assign Value</h3>"
	"<select id=\"file2-select\"></select>"
	"<input id=\"file2-value\" type=\"text\" pattern=\"\\d*\" placeholder=\"12345\"/>"
	"<button onclick=\"assign_value_to_file()\">Update DB</button>"
"</div>"

"<div id=\"tagging\">"

// elem = (id,text,fn)
#define CREATE_TAG_SELECT(r, data, elem) \
	"<div id=\"" BOOST_PP_TUPLE_ELEM(0, elem) "-container\" class=\"tagselect-container\">" \
		"<button id=\"" BOOST_PP_TUPLE_ELEM(0, elem) "-btn\" onclick=\"" BOOST_PP_TUPLE_ELEM(2, elem) "\">" BOOST_PP_TUPLE_ELEM(1, elem) "</button>" \
		"<select class=\"tagselect\" id=\"" BOOST_PP_TUPLE_ELEM(0, elem) "\" multiple=\"multiple\"></select>" \
	"</div>"
#define TAG_FN1 \
	"add_parent_tags_then(tag_id, '#tagselect-self-p', function(){" \
		"display_parent_tags(tag_id, '#parents');" \
	"})"
#define TAG_FN2 \
	"add_child_tags_then(tag_id, '#tagselect-self-c', function(){" \
		"display_child_tags(tag_id, '#children');" \
	"})"
BOOST_PP_SEQ_FOR_EACH(CREATE_TAG_SELECT, _, BOOST_PP_VARIADIC_SEQ_TO_SEQ(("tagselect-self-p","Add Parent Tags",TAG_FN1)("tagselect-self-c","Add Child Tags",TAG_FN2)))

"<div id=\"user-info\">"
	"<h3 id=\"user-fullname\"></h3>"
	
	"<img id=\"verified\" src=\"https://freeiconshop.com/wp-content/uploads/edd/checkmark-flat.png\"/>"
	
	"<a id=\"n-followers\"></a>"
	"<a id=\"n-following\"></a>"
	
	"<a onclick=\"display_posts(db_id,user_id,'u')\">Authored Posts</a>"
	"<a onclick=\"display_posts(db_id,user_id,'l')\">Liked Posts</a>"
	"<a onclick=\"display_posts(db_id,user_id,'c')\">Commented Posts</a>"
"</div>"

#define CREATE_SELECT(r, data, elem) \
	"<div id=\"" elem "select-container\">" \
		"<select id=\"" elem "select\"></select>" \
	"</div>"
BOOST_PP_SEQ_FOR_EACH(CREATE_SELECT, _, ("dir")("device")("protocol"))

#include "components/change-file-to-backup.html"

#define CREATE__ADD_TO_DB__DIALOG(r, data, elem) \
	"<div id=\"add-" BOOST_PP_TUPLE_ELEM(0, elem) "-dialog\">" \
		"<input id=\"add-" BOOST_PP_TUPLE_ELEM(0, elem) "-input\" type=\"text\" placeholder=\"" BOOST_PP_TUPLE_ELEM(1, elem) "\"/>" \
		"<button class=\"inline\" onclick=\"add_to_db__append('" BOOST_PP_TUPLE_ELEM(0, elem) "')\">+</button>" \
		"<div id=\"add-" BOOST_PP_TUPLE_ELEM(0, elem) "-queue\" contenteditable=\"true\"></div>" \
		"<button onclick=\"add_to_db('" BOOST_PP_TUPLE_ELEM(0, elem) "')\">Add to database</button>" \
	"</div>"
BOOST_PP_SEQ_FOR_EACH(CREATE__ADD_TO_DB__DIALOG, _, BOOST_PP_VARIADIC_SEQ_TO_SEQ(("t","New Tag Name")("f","File URL, e.g. https://www.youtube.com/watch?v=dQw4w9WgXcQ")("d","'Directory' URL, i.e. a prefix of file URLS, e.g. https://www.youtube.com/watch?v=")("D","'Device' URL, e.g. https://youtube.com/")))

"<div id=\"add-f-backup\" class=\"hidden\">"
	"<input id=\"add-f-backup-url\" placeholder=\"Use this URL instead...\"/>"
	ADD_TOGGLE("add-f-backup-ytdl","YouTube-DL?")
	"<a onclick=\"backup_files()\">Send backup request</a>"
"</div>"

"<div id=\"file-info\">"
	"<a id=\"dir_name\"></a>"
	"<br/>"
	"<a onclick=\"toggle_file_add_backup_dialog()\">+Backups</a>"
	"<br/>"
	"<div id=\"view\">"
		"<video id=\"view-video\" controls>"
			"<source>Browser does not support videos</source>"
		"</video>"
		"<audio id=\"view-audio\" controls>"
			"<source>Browser does not support audio</source>"
		"</audio>"
		"<img id=\"view-img\"/>"
		"<iframe id=\"view-iframe\" frameborder=\"0\" scrolling=\"no\" allow=\"autoplay; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen>Browser does not support iframes</iframe>"
		"<object id=\"view-object\">Browser does not support object elements</object>"
		"<div id=\"view-yt-player\">"
			"<div id=\"yt-player\"></div>"
			// This div is *replaced* by the Youtube IFrame API, so causes issues when told to hide while it is loading
		"</div>"
	"</div>"
	"<br/>"
	ADD_TOGGLE("autoplay","Autoplay")
	"<button onclick=\"show_update_orig_src_dialog()\">Update src</button>"
	"<div id=\"view-btns-container\">"
		"View"
		"<br/>"
		"<div id=\"view-btns\">"
			"Warning: Remote backup files will not display."
			"<button id=\"view-btn-main\" class=\"view-btn\" onclick=\"display_this_file()\">"
				"Original"
			"</button>"
			"<div id=\"view-btns-backups\"></div>"
		"</div>"
	"</div>"
	
	"<div id=\"posts-container\">"
		"<div id=\"db-links\"></div>"
		"<div id=\"post-container\">"
			"<a id=\"post-user\" class=\"user\"></a>"
			"<time id=\"post-time\"></time>"
			"<div id=\"post-text\"></div>"
			
			"<br/>"
			"<a onclick=\"view_likes()\">Likes</a>"
			"<div id=\"likes\">"
				"<a onclick=\"hide('likes')\">Hide</a>"
				"<div id=\"likes-ls\"></div>"
			"</div>"
			"<br/>"
			
			"<div id=\"cmnts-container\">"
				"<br/>"
				"<a onclick=\"toggle('cmnts')\">Show/Hide Comments</a>"
				"<div id=\"cmnts\"></div>"
			"</div>"
		"</div>"
	"</div>"
"</div>"

BOOST_PP_SEQ_FOR_EACH(CREATE_TAG_SELECT, _, BOOST_PP_VARIADIC_SEQ_TO_SEQ(("tagselect-files","Add Tags to Files","tag_files_then(get_file_ids(), '#tagselect-files', file_tagger_fn)")))
#undef FILE_TAGGER_FN
#undef FILE_TAGGER_FILE_IDS

"</div>"

"<div id=\"text-editor\">"
	"<h2 contenteditable=\"true\">Edit file name here...</h2>"
	"<button onclick=\"text_editor_save()\">Save</button>"
	"<div id=\"text-edit\" contenteditable=\"true\">"
		"Write text here..."
	"</div>"
"</div>"

#define COL_NAMES ("Name")
#define COL_FILTERS (1,"regexp")
#define TBL_ID "t"
#define TBL_NAME_COLS "[0]"
#define TBL_TAGS_COLS "[]"
#include "components/tbl.html"

#define COL_NAMES ("Name")("Device")
#define COL_FILTERS (1,"regexp")(1,"regexp")
#define TBL_ID "d"
#define TBL_NAME_COLS "[0,1]"
#define TBL_TAGS_COLS "[]"
#include "components/tbl.html"

#define ACTION_BTNS ("select_rows('#f .tbody .tr:not(.hidden)')","Select All")("deselect_rows('#f .tbody .tr', 1); deselect_rows('#f .tbody .tr', 2); deselect_rows('#f .tbody .tr', 3);","Deselect All")("merge_files()","Merge Files")("toggle_file_add_backup_dialog()","Backup")("toggle('file2-container')","Add/Update Value")("view_files_as_playlist(get_file_ids())","View as Playlist")
#define IS_SELECTABLE
#define COL_NAMES ("")("Name")("In Databases")("Tags")("Size")
#define COL_FILTERS (0,"")(1,"regexp")(1,"regexp")(1,"regexp")(1,"123.4 MB")
#define TBL_ID "f"
#define TBL_NAME_COLS "[1]"
#define TBL_TAGS_COLS "[2]"
#include "components/tbl.html"

R"=========(
    </div>
  </div>
  <div class="right-side">
    <div class="account">
      <button class="account-button">
        <svg stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1" viewBox="0 0 24 24">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
          <path d="M22 6l-10 7L2 6" />
        </svg>
      </button>
      <button class="account-button">
        <svg stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1" viewBox="0 0 24 24">
          <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 01-3.46 0" />
        </svg>
      </button>
      <span class="account-user"><p id="username">Guest</p>
        <img src="https://upload.wikimedia.org/wikipedia/commons/9/93/Google_Contacts_icon.svg" class="account-profile" alt="">
        <span>▼</span>
      </span>
    </div>
)========="
#define CREATE_SIDE_WRAPPER(r, data, elem) \
	"<div id=\"" elem "-container\" class=\"side-wrapper\">" \
		"<div class=\"side-title\">" elem "</div>" \
		"<div id=\"" elem "\"></div>" \
	"</div>"
BOOST_PP_SEQ_FOR_EACH(CREATE_SIDE_WRAPPER, _, ("values")("parents")("children")("tags"))
R"=========(
    <div class="search-bar right-search">
      <input type="text" placeholder="Search" />
      <div class="search-bar-svgs">
        <svg stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="3"/>
          <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
        </svg>
        <svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 469.34 469.34">
          <path d="M456.84 76.17l-64-64.06c-16.13-16.13-44.18-16.17-60.37.04L45.77 301.67a10.73 10.73 0 00-2.7 4.59L.41 455.73a10.68 10.68 0 0013.19 13.2l149.33-42.7c1.73-.5 3.3-1.42 4.58-2.7l289.33-286.98c8.06-8.07 12.5-18.78 12.5-30.19s-4.44-22.12-12.5-30.2zM285.99 89.74L325.25 129l-205 205-14.7-29.44a10.67 10.67 0 00-9.55-5.9H78.92L286 89.75zM26.2 443.14l13.9-48.64 34.74 34.74-48.64 13.9zm123.14-35.18L98.3 422.54l-51.5-51.5L61.38 320H89.4l18.38 36.77a10.67 10.67 0 004.77 4.77l36.78 18.39v28.03zm21.33-17.54v-17.09c0-4.04-2.28-7.72-5.9-9.54l-29.43-14.7 205-205 39.26 39.26-208.93 207.07zm271.11-268.7l-47.03 46.61L301 74.6l46.59-47c8.06-8.07 22.1-8.07 30.16 0l64 64c4.03 4.03 6.25 9.38 6.25 15.08s-2.22 11.05-6.22 15.05z" /></svg>
        <svg stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
      <path d="M12 5v14M5 12h14"/>
    </svg>
      </div>
    </div>
  </div>
</div>
)========="

"</body>"
"</html>"
